{% extends 'layout.html' %}
{% block content %}
<div class="container">
  <h1>{{ area_lang }}</h1>
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button href="#" class="nav-link {% if not aoi %} active {% endif %}" id="add-tab" data-bs-toggle="tab" data-bs-target="#add-tab-pane" type="button" role="tab">{{ add_area_lang }}</button>
    </li>
    <li class="nav-item" role="presentation">
      <button href="#" class="nav-link {% if aoi %} active {% endif %}" id="aoi-tab" data-bs-toggle="tab" data-bs-target="#aoi-tab-pane" type="button" role="tab">{{ aoi_area_lang }}</button>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show {% if not aoi %} active {% endif %}" id="add-tab-pane" role="tabpanel">
      <form action="/newarea/add" id="newarea-add" method="post" class="needs-validation" enctype="multipart/form-data" novalidate>
        <div class="row g-3 p-2">
          <label for="submit_response" class="form-label" id="submit_response">{{ submit_response }}</label>
        </div>
        <div class="row g-3 p-2">
          <label for="description" class="form-label" >{{ description_lang }}</label>
          <input type="text" class="form-control" name="description" id="description" style="margin-top: 0px;" placeholder="" value="" required>
        </div>
        <div class="row g-3 p-2">
          <div class="col-sm-4">
            <label for="typeofarea" class="form-label">{{toa_lang}}</label>
            <select class="form-select" name="typeofarea" id="typeofarea" required>
              <option value="">{{ chose_lang }}</option>
              <option value="avoid">{{ avoid_lang }}</option>
              <option value="interest">{{ interest_lang }}</option>
            </select>
          </div>
          <div class="col-sm-4">
            <label for="date" class="form-label">{{ date_lang }}</label>
            <input type="date" class="form-control" name="date" id="date" placeholder="" value="" required>
          </div>
          <div class="col-sm-4">
            <label for="images" class="form-label">{{ images_lang }}</label><br>
            <input type="file" name="file" id="images" accept="image/*" multiple />
          </div>
        </div>
        <div class="row g-3 p-2">
          <input id="polygonData" type="hidden" name="polygonData">

          <div id="map" style="height: 450px;">
          </div>
          <script>
              document.addEventListener('DOMContentLoaded', function() {
                  var map = L.map('map').setView([52.353089, 9.745069], 14);

                  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                  }).addTo(map);

                  var drawnItems = new L.FeatureGroup();
                  map.addLayer(drawnItems);

                  var drawControl = new L.Control.Draw({
                      edit: {
                          featureGroup: drawnItems
                      },
                      draw: {
                          polygon: true,
                          polyline: false,
                          rectangle: false,
                          circle: false,
                          marker: false,
                          circlemarker: false
                      }
                  });
                  map.addControl(drawControl);

                  map.on(L.Draw.Event.CREATED, function (event) {
                      var layer = event.layer;
                      drawnItems.addLayer(layer);
                  });

                  var form = document.getElementById('newarea-add');
                  if (form) {
                      form.addEventListener('submit', function() {
                          var polygonData = [];
                          drawnItems.eachLayer(function(layer) {
                              if (layer instanceof L.Polygon) {
                                  polygonData.push(layer.getLatLngs());
                              }
                          });
                          document.getElementById('polygonData').value = JSON.stringify(polygonData);
                      });
                  }
              });
          </script>
        </div>
        <div class="row g-3 p-2">
          <div class="col-sm-12">
            <button class="btn btn-primary btn-lg" type="submit">{{ submit_lang }}</button>
          </div>
        </div>
      </form>
    </div>

    <div class="tab-pane fade show {% if aoi %} active {% endif %}" id="aoi-tab-pane" role="tabpanel">
        <div class="row g-3 p-2">
          <label for="submit_response" class="form-label" id="submit_response">{{ submit_response }}</label>
        </div>
      <p class="g-3 p-2">{{ aoi_description_lang }}</p>
        <div class="col">
      <form action="/newarea/get_aois" id="newarea-aoi" method="post" class="needs-validation" novalidate>
        <div class="row g-3 p-2">
          <div class="col-sm-4">
            <label for="aoi_date" class="form-label">{{ date_lang }}</label>
            <input type="date" class="form-control" name="aoi_date" id="aoi_date" placeholder="" value={{ current_date }} required>
          </div>
          <div class="col-sm-4">
            <label for="resolution" class="form-label">{{ resolution_lang }}</label>
            <input type="number" class="form-control" name="resolution" id="resolution" placeholder="" value={{ resolution_value }} required>
          </div>
          <div class="col-sm-4">
            <label for="cloud_coverage" class="form-label">{{ cloud_coverage_lang }}</label>
            <input type="number" step="0.1" min="0" max="1" class="form-control" name="cloud_coverage" id="cloud_coverage" placeholder="" value={{ cloud_coverage_value }} required>
          </div>
        </div>
        <div class="row g-3 p-2">
          <div class="col-sm-4">
            <label for="n_areas" class="form-label">{{ n_areas_lang }}</label>
            <input type="number" class="form-control" name="n_areas" id="n_areas" placeholder="" value={{ n_areas_value }} required>
          </div>
          <div class="col-sm-4">
            <label for="lake_query" class="form-label">{{ lake_query_lang }}</label>
            <input type="text" class="form-control" name="lake_query" id="lake_query" placeholder="" value="{{ lake_query_value }}" required>
          </div>
        </div>
        <div class="row g-3 p-2">
          <div class="col-sm-12">
            <button class="btn btn-primary btn-lg" type="submit">{{ get_aoi_lang }}</button>
          </div>
        </div>
      </form>
        {{ aoi_result|safe }}
        {% if aoi_req %}
          <form action="/newarea/save_aois" method="post">
              <button class="btn btn-primary btn-lg" type="submit">{{ submit_lang }}</button>
              <textarea style="visibility: hidden;" name="aois_ts" id=aois_ts >{{ aois_to_save }}</textarea>
              <input type="hidden" name="date_to_save" id=date_to_save value="{{ date_to_save }}">
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
